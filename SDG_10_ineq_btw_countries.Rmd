---
title: "Inequality between countries"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    theme: paper
    source_code: embed
    vertical_layout: fill
runtime: shiny
---

```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library("here")
library("data.table")
library("ggplot2")
library("plotly")

#----------------------------------------------------------
#   subfunctions
#----------------------------------------------------------
# source(here("R", "utils.R"))


qtile <- function(x) {
  nq  <- 10
  N   <-  length(x)
  csw <-  1:N
  qp  <-   floor(csw/((N+1)/nq)) + 1
  return(qp)
}


#----------------------------------------------------------
#   Aux data
#----------------------------------------------------------
cr  <- readr::read_rds(here("data", "cty_regs_names.rds"))
dfc <- readr::read_rds(here("data", "dfc.rds"))


#----------------------------------------------------------
#   Calculate Quantiles
#----------------------------------------------------------

# set data.table

DT <- as.data.table(dfc)
cr <- as.data.table(cr)
setnames(DT, "threshold", "pv")


# Sort
setorder(DT, year, goal, pv)

DT <- DT[
  # remove old years
  year >= 1990
  ][,
  # multiply by 100
  goal := 100*goal
  
  ][
  ,# Create deciles in each percentile
  qp := qtile(pv),
  by = .(year, goal)
  
  ][
    ,
    headcount := NULL
  ][
    # Merge country names and regions
    cr, 
    on = .(countrycode)
    ]


yrs <- DT[, unique(year)]

```

Sidebar {.sidebar data-width=350}
-----------------------------------------------------------------------

```{r}
sliderInput("pc", 
            label = "Percentile",
            min = 10, max = 100, value = 50, step = 10)

sliderInput("qps", 
            label = "Decile within percentiles",
            min = 1, max = 10, value = 1, step = 1)

sliderInput("mrt", 
            label = "Max decile",
            min = 1, max = 10, value = 9, step = 1)

selectInput("yr", 
            label    = "Years",
            choices  = yrs, 
            selected = c(1993, 2002, 2010, 2015, 2017), 
            multiple = TRUE)


selectInput("ms", 
            label = "Measure:",
            choices = c("sum", "mean", "min", "max"),
            selected = "sum")

sliderInput("nm", 
            label = "Decile within percentile (Numerator):",
            min = 1, max = 10, value = c(8,9), step = 1)

sliderInput("dn", 
            label = "Decile within percentile (Denominator):",
            min = 1, max = 10, value = c(1,4), step = 1)





```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Normalized Deciles

```{r}

DTF <- reactive({
  DT[
    qp == input$qps
    ][
      ,
      .SD[which.max(pv)],
      by = .(year, goal)
    ]
})
  

DG <- reactive({
  DT[goal == input$pc 
     & !is.na(pv) 
     & year  %in% input$yr
     & qp <= input$mrt
     ][
      DTF(),
      on = .(year, goal),
      pvd := i.pv
      ][
        ,
        ratio := pv/pvd
      ][
        , # Create Text variable
        text := paste0("Country: ", countryname, "\n",
                       "Year: ", year, "\n",
                       "Ratio:", round(ratio, digits = 2), "\n")
      ]

})
```

```{r}
renderPlotly({
  pn <- ggplot(DG(),
       aes(
         x = pv,
         y = ratio,
         color = factor(year)
       )
       ) +
  geom_line() +
  geom_point(aes( 
         text = text)) +
  theme_minimal()
  
  ggplotly(pn, tooltip = "text")
})
```


### Density over time of percentile 
```{r}
renderPlotly({
  
  pd <- ggplot(DG(),
       aes(x = pv,
           fill  = factor(year)
       )
    ) +
    geom_density(alpha = .2)+
    theme_minimal() +
    labs(x = "Distribution of medians over time") +
    theme(
      legend.title = element_blank(),
      legend.position = c(.8, .5),
      legend.direction = "horizontal"
    )
  
  ggplotly(pd)
   
})

```




Row
-----------------------------------------------------------------------

### Evolution of ratio 

```{r}

DF <- reactive({
  
  # calculation
  
  calc <- paste0(".(", input$ms, "  = ", input$ms, "(pv, na.rm = TRUE))")
  calc <- parse(text = calc)
  
  
  DW <- DT[
    # Filter selected percentile
    goal == input$pc & !is.na(pv) & year  %in% input$yr
  
    ][
    # classify numerator and denominator
    ,
    gr := ifelse(qp %between% input$nm, "nm",
                 ifelse(qp %between% input$dn, "dn", NA_character_ )
                 )
  
    ][
    # remove not necessary data
    !is.na(gr)
    ][
      , # Make requested calculation
      eval(calc),
      by = .(year, goal, gr)
    ]
  
  # Reshape to wide
  DW <- dcast.data.table(DW,
              year ~ gr,
              value.var = input$ms)
  
  # Ratio
  DW[
    ,
    ratio := round(nm/dn, digits = 2)
    ]

})


renderPlotly({
 pr <- ggplot(DF(),
         aes(
           x = year,
           y = ratio)
         )+
    geom_point() +
    geom_line() +
    theme_minimal() +
    labs(y = "Evolution of ratio") +
    theme(
      legend.title = element_blank()
    )
  
  ggplotly(pr)

})





```


